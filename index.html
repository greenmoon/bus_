<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaiwanBus Monitor</title>
</head>
<body>
  <h2>Bus Status Monitor for「第一製藥廠」</h2>
  <p>Monitoring the TaiwanBus site for "<strong>進站中</strong>" at stop <strong>第一製藥廠</strong>...</p>

  <script>
    const corsProxy = "https://cors-anywhere.herokuapp.com/"; // Public CORS proxy
    const busUrl = "https://www.taiwanbus.tw/eBUSPage/Query/QueryResult.aspx?rno=90010&rn=1610761022789&lan=C";

    // Sound alert
    const beepSound = new Audio("data:audio/wav;base64,UklGRsQPAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YaAPAAB/qtDt/P3v066DWDETAwENKEx3o8ro+v7y2bWLXzcY37f/H9D52vgMGj384PdMnTxGfUrGFeMeX0mZb8Z5nlci7O8z85qpkXjep38nTZcRMJB+li4M0T/7fZXNATwrMFyPZKPPP3YR8LiP/d9Ki9O354vKCu/j/e/g+KB3m/46LmZ8HbSgn7ocUcLh/w/XcK/o8AAGLjh53+792GYIk+Y/pblfOW4z+dfIXz14LNm29C/AAAA");

    async function checkBusStatus() {
      try {
        const response = await fetch(corsProxy + busUrl);
        if (!response.ok) {
          console.error("Network response was not OK:", response.status);
          return;
        }
        const htmlText = await response.text();

        // Parse the HTML response
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, "text/html");

        // Find "第一製藥廠" in the response and check if "進站中" is present
        let isArriving = false;
        const cells = doc.querySelectorAll("td");
        cells.forEach(cell => {
          const text = cell.textContent.trim();
          if (text.includes("第一製藥廠")) {
            const nextCell = cell.nextElementSibling;
            if (nextCell && nextCell.textContent.includes("進站中")) {
              isArriving = true;
            }
          }
        });

        // If "進站中" is detected, trigger alert
        if (isArriving) {
          beepSound.play();
          if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]); // Vibrate on supported devices
          }
          alert("【通知】公車即將進站：第一製藥廠 － Bus is arriving (進站中)!");
        }
      } catch (error) {
        console.error("Error fetching bus data:", error);
      }
    }

    // Check bus status every 10 seconds
    checkBusStatus();
    setInterval(checkBusStatus, 10000);
  </script>
</body>
</html>
